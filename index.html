<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APACHE II Score System - Org: 670423</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <style>
        body { background-color: #f4f6f9; font-family: "Microsoft JhengHei", sans-serif; }
        .header-bar { background-color: #2c3e50; color: white; padding: 15px 0; border-bottom: 5px solid #3498db; }
        .card-header { font-weight: bold; background-color: #e9ecef; }
        .score-panel { position: sticky; top: 20px; z-index: 1000; }
        .score-display { font-size: 3rem; font-weight: 800; color: #e74c3c; text-align: center; }
        .mortality-display { font-size: 1.2rem; text-align: center; color: #7f8c8d; }
        
        /* æ¨™ç¤ºè‡ªå‹•å¡«å…¥çš„æ¬„ä½ */
        .auto-filled { border: 2px solid #3498db !important; background-color: #ebf5fb !important; }
        
        /* Debug Log */
        #debug-log { font-family: monospace; font-size: 0.8rem; height: 150px; overflow-y: scroll; background: #333; color: #0f0; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="header-bar mb-4">
    <div class="container d-flex justify-content-between align-items-center">
        <div>
            <h3 class="m-0">ğŸ¥ APACHE II é‡ç—‡è©•åˆ†ç³»çµ±</h3>
            <small>æ‰€å±¬æ©Ÿæ§‹ä»£ç¢¼ï¼š<span class="badge bg-info">Organization/670423</span></small>
        </div>
        <div class="text-end">
            <div id="patient-info-display">è®€å–ä¸­...</div>
            <small id="fhir-status" class="text-warning">Connecting...</small>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-lg-8">
            <form id="apacheForm">
                
                <div class="card mb-3 shadow-sm">
                    <div class="card-header text-primary">A. åŸºæœ¬è³‡è¨Š (Age & Chronic)</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">å¹´é½¡ (æ­²)</label>
                                <input type="number" class="form-control" id="age" placeholder="Auto-load...">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">æ…¢æ€§å¥åº·ç‹€æ³</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="chronic">
                                    <label class="form-check-label" for="chronic">
                                        åš´é‡å™¨å®˜è¡°ç«­ / å…ç–«ä¸å…¨
                                    </label>
                                </div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="emergency-surgery">
                                    <label class="form-check-label" for="emergency-surgery">
                                        æ¥å—éç·Šæ€¥æ‰‹è¡“ (Emergency Surgery)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3 shadow-sm">
                    <div class="card-header text-success">B. ç”Ÿå‘½å¾µè±¡ (Vital Signs)</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">é«”æº« (Â°C)</label>
                                <input type="number" step="0.1" class="form-control fhir-bind" id="temp" data-loinc="8310-5,8331-1">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">å¹³å‡å‹•è„ˆå£“ (mmHg)</label>
                                <input type="number" class="form-control fhir-bind" id="map" data-loinc="8478-0">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">å¿ƒè·³ (bpm)</label>
                                <input type="number" class="form-control fhir-bind" id="hr" data-loinc="8867-4">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">å‘¼å¸é€Ÿç‡ (/min)</label>
                                <input type="number" class="form-control fhir-bind" id="rr" data-loinc="9279-1">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3 shadow-sm">
                    <div class="card-header text-warning">C. æ°§åˆç‹€æ³ (Oxygenation)</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">PaO2 (mmHg)</label>
                                <input type="number" class="form-control fhir-bind" id="pao2" data-loinc="2703-7">
                                <small class="text-muted">è‹¥ FiO2 < 0.5 ä½¿ç”¨æ­¤é …</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">A-aDO2 (mmHg)</label>
                                <input type="number" class="form-control" id="aado2">
                                <small class="text-muted">è‹¥ FiO2 >= 0.5 ä½¿ç”¨æ­¤é … (éœ€æ‰‹ç®—)</small>
                            </div>
                            <div class="col-12 form-check">
                                <input class="form-check-input" type="checkbox" id="fio2-high">
                                <label class="form-check-label" for="fio2-high">
                                    FiO2 >= 50% (å‹¾é¸å¾Œå°‡ä½¿ç”¨ A-aDO2 è¨ˆåˆ†)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3 shadow-sm">
                    <div class="card-header text-info">D. è¡€æ¶²åŒ–å­¸ (Chemistry/Hematology)</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">å‹•è„ˆè¡€ pH</label>
                                <input type="number" step="0.01" class="form-control fhir-bind" id="ph" data-loinc="2744-1">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">è¡€éˆ‰ (Na, mmol/L)</label>
                                <input type="number" step="0.1" class="form-control fhir-bind" id="na" data-loinc="2951-2">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">è¡€é‰€ (K, mmol/L)</label>
                                <input type="number" step="0.1" class="form-control fhir-bind" id="k" data-loinc="2823-3">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">è‚Œé…¸é… (Cr, mg/dL)</label>
                                <input type="number" step="0.1" class="form-control fhir-bind" id="cr" data-loinc="2160-0">
                                <div class="form-check mt-1">
                                    <input class="form-check-input" type="checkbox" id="arf">
                                    <label class="form-check-label" style="font-size: 0.8rem;">æ€¥æ€§è…è¡°ç«­ (ARF)</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">è¡€çƒå®¹ç©æ¯” (Hct, %)</label>
                                <input type="number" step="0.1" class="form-control fhir-bind" id="hct" data-loinc="20570-8,4544-3">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">ç™½è¡€çƒ (WBC, x1000)</label>
                                <input type="number" step="0.1" class="form-control fhir-bind" id="wbc" data-loinc="6690-2,26464-8">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3 shadow-sm">
                    <div class="card-header text-danger">E. ç¥ç¶“ç³»çµ± (Neurological)</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <label class="form-label">GCS ç¸½åˆ† (3-15)</label>
                                <input type="number" class="form-control fhir-bind" id="gcs" max="15" min="3" value="15" data-loinc="9269-2">
                                <small class="text-muted">ç¨‹å¼é‚è¼¯ï¼šå¾—åˆ† = 15 - GCS</small>
                            </div>
                        </div>
                    </div>
                </div>

            </form>
        </div>

        <div class="col-lg-4">
            <div class="card shadow score-panel">
                <div class="card-header bg-dark text-white">è©•åˆ†çµæœ</div>
                <div class="card-body">
                    <p class="text-center text-muted mb-0">Total APACHE II Score</p>
                    <div id="finalScore" class="score-display">0</div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <span>å¹´é½¡åˆ†æ•¸:</span> <strong id="scoreAge">0</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>æ…¢æ€§ç—…åˆ†æ•¸:</span> <strong id="scoreChronic">0</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>ç”Ÿç†æ•¸å€¼åˆ†æ•¸:</span> <strong id="scorePhys">0</strong>
                    </div>
                    <hr>
                    <p class="text-center text-muted mb-0">é ä¼°æ­»äº¡ç‡ (Approx)</p>
                    <div id="mortalityRate" class="mortality-display">-- %</div>
                    
                    <button class="btn btn-primary w-100 mt-3" onclick="calculateApacheII()">é‡æ–°è¨ˆç®—</button>
                    <button class="btn btn-outline-secondary w-100 mt-2 btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#debugArea">é¡¯ç¤º/éš±è— Debug Log</button>
                </div>
            </div>
            
            <div class="collapse mt-3" id="debugArea">
                <div id="debug-log"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const TARGET_ORG_ID = "670423";
    
    // å·¥å…·ï¼šLogger
    function log(msg, data) {
        const div = document.getElementById('debug-log');
        const time = new Date().toLocaleTimeString();
        let html = `<div><span style="color:#aaa">[${time}]</span> ${msg}</div>`;
        if(data) html += `<div style="color:#888; font-size:0.7em;">${JSON.stringify(data).substring(0, 100)}...</div>`;
        div.innerHTML = html + div.innerHTML;
        console.log(msg, data);
    }

    // åš´è¬¹çš„è¨ˆåˆ†é‚è¼¯ (ä¾ç…§ Knaus et al.)
    // Helper: æª¢æŸ¥æ•¸å€¼è½åœ¨å“ªå€‹å€é–“ä¸¦å›å‚³åˆ†æ•¸
    function getScore(val, ranges) {
        if (val === "" || val === undefined || isNaN(val)) return 0; // ç„¡è³‡æ–™é è¨­0åˆ†(è¦–ç‚ºæ­£å¸¸)
        val = parseFloat(val);
        for (let r of ranges) {
            // å€é–“å®šç¾©ï¼š[min, max]
            let min = r.min !== undefined ? r.min : -Infinity;
            let max = r.max !== undefined ? r.max : Infinity;
            if (val >= min && val <= max) return r.score;
        }
        return 0; // è½åœ¨æ­£å¸¸å€é–“
    }

    function calculateApacheII() {
        let totalScore = 0;
        let physScore = 0;
        
        // 1. å¹´é½¡
        const age = parseFloat(document.getElementById('age').value) || 0;
        let ageScore = 0;
        if (age >= 75) ageScore = 6;
        else if (age >= 65) ageScore = 5;
        else if (age >= 55) ageScore = 3;
        else if (age >= 45) ageScore = 2;
        document.getElementById('scoreAge').innerText = ageScore;

        // 2. æ…¢æ€§ç—… (Chronic Health)
        let chronicScore = 0;
        const hasChronic = document.getElementById('chronic').checked;
        const isEmergency = document.getElementById('emergency-surgery').checked;
        
        if (hasChronic) {
            // é›»è…¦æ¨¡æ“¬é‚è¼¯ï¼šå¦‚æœæœ‰æ…¢æ€§ç—…å²
            // éæ‰‹è¡“æˆ–ç·Šæ€¥æ‰‹è¡“ +5ï¼Œæ“‡æœŸæ‰‹è¡“ +2 (é€™è£¡ç°¡åŒ–ç‚ºç·Šæ€¥+5, å¦å‰‡+2)
            chronicScore = isEmergency ? 5 : 2; 
            // è‹¥ç—…äººéæ‰‹è¡“å…¥é™¢ä¹Ÿæ˜¯+5ï¼Œé€™è£¡ç‚º Demo ç°¡åŒ–é‚è¼¯
        }
        document.getElementById('scoreChronic').innerText = chronicScore;

        // 3. ç”Ÿç†æ•¸å€¼ (Physiology) - å®šç¾©åš´è¬¹è¦å‰‡
        // æ ¼å¼: {min: ä¸‹é™, max: ä¸Šé™, score: åˆ†æ•¸}
        
        // é«”æº« (Rectal)
        physScore += getScore(document.getElementById('temp').value, [
            {min: 41, score: 4}, {min: 39, max: 40.9, score: 3}, {min: 38.5, max: 38.9, score: 1},
            {min: 36, max: 38.4, score: 0}, {min: 34, max: 35.9, score: 1}, {min: 32, max: 33.9, score: 2},
            {min: 30, max: 31.9, score: 3}, {max: 29.9, score: 4}
        ]);

        // MAP
        physScore += getScore(document.getElementById('map').value, [
            {min: 160, score: 4}, {min: 130, max: 159, score: 3}, {min: 110, max: 129, score: 2},
            {min: 70, max: 109, score: 0}, {min: 50, max: 69, score: 2}, {max: 49, score: 4}
        ]);

        // HR
        physScore += getScore(document.getElementById('hr').value, [
            {min: 180, score: 4}, {min: 140, max: 179, score: 3}, {min: 110, max: 139, score: 2},
            {min: 70, max: 109, score: 0}, {min: 55, max: 69, score: 2}, {min: 40, max: 54, score: 3}, {max: 39, score: 4}
        ]);

        // RR
        physScore += getScore(document.getElementById('rr').value, [
            {min: 50, score: 4}, {min: 35, max: 49, score: 3}, {min: 25, max: 34, score: 1},
            {min: 12, max: 24, score: 0}, {min: 10, max: 11, score: 1}, {min: 6, max: 9, score: 2}, {max: 5, score: 4}
        ]);

        // Oxygenation
        const isFiO2High = document.getElementById('fio2-high').checked;
        if (isFiO2High) {
            // Use A-aDO2
            physScore += getScore(document.getElementById('aado2').value, [
                {min: 500, score: 4}, {min: 350, max: 499, score: 3}, {min: 200, max: 349, score: 2}, {max: 199, score: 0}
            ]);
        } else {
            // Use PaO2
            physScore += getScore(document.getElementById('pao2').value, [
                {min: 70, score: 0}, {min: 61, max: 69, score: 1}, {min: 55, max: 60, score: 3}, {max: 54, score: 4}
            ]);
        }

        // pH
        physScore += getScore(document.getElementById('ph').value, [
            {min: 7.7, score: 4}, {min: 7.6, max: 7.69, score: 3}, {min: 7.5, max: 7.59, score: 1},
            {min: 7.33, max: 7.49, score: 0}, {min: 7.25, max: 7.32, score: 2}, {min: 7.15, max: 7.24, score: 3}, {max: 7.14, score: 4}
        ]);

        // Na
        physScore += getScore(document.getElementById('na').value, [
            {min: 180, score: 4}, {min: 160, max: 179, score: 3}, {min: 155, max: 159, score: 2},
            {min: 150, max: 154, score: 1}, {min: 130, max: 149, score: 0}, {min: 120, max: 129, score: 2}, {max: 119, score: 4}
        ]);

        // K
        physScore += getScore(document.getElementById('k').value, [
            {min: 7, score: 4}, {min: 6, max: 6.9, score: 3}, {min: 5.5, max: 5.9, score: 1},
            {min: 3.5, max: 5.4, score: 0}, {min: 3, max: 3.4, score: 1}, {min: 2.5, max: 2.9, score: 2}, {max: 2.4, score: 4}
        ]);

        // Creatinine (ARF check: score x2)
        let crScore = getScore(document.getElementById('cr').value, [
            {min: 3.5, score: 4}, {min: 2, max: 3.4, score: 3}, {min: 1.5, max: 1.9, score: 2},
            {min: 0.6, max: 1.4, score: 0}, {max: 0.5, score: 2}
        ]);
        if (document.getElementById('arf').checked) crScore *= 2;
        physScore += crScore;

        // Hct
        physScore += getScore(document.getElementById('hct').value, [
            {min: 60, score: 4}, {min: 50, max: 59.9, score: 2}, {min: 46, max: 49.9, score: 1},
            {min: 30, max: 45.9, score: 0}, {min: 20, max: 29.9, score: 2}, {max: 19.9, score: 4}
        ]);

        // WBC
        physScore += getScore(document.getElementById('wbc').value, [
            {min: 40, score: 4}, {min: 20, max: 39.9, score: 2}, {min: 15, max: 19.9, score: 1},
            {min: 3, max: 14.9, score: 0}, {min: 1, max: 2.9, score: 2}, {max: 0.9, score: 4}
        ]);

        // GCS (åˆ†æ•¸ = 15 - GCS)
        const gcs = parseFloat(document.getElementById('gcs').value) || 15;
        physScore += (15 - gcs);

        document.getElementById('scorePhys').innerText = physScore;

        // ç¸½åˆ†
        totalScore = ageScore + chronicScore + physScore;
        document.getElementById('finalScore').innerText = totalScore;

        // é ä¼°æ­»äº¡ç‡ (Logistic Regression: ln(R/1-R) = -3.517 + (APACHE II Score x 0.146) + 0.603(if post-emergency))
        // é€™è£¡åƒ…ä½œç²—ç•¥ä¼°è¨ˆå±•ç¤º
        const logit = -3.517 + (totalScore * 0.146) + (isEmergency ? 0.603 : 0);
        const risk = Math.exp(logit) / (1 + Math.exp(logit));
        document.getElementById('mortalityRate').innerText = (risk * 100).toFixed(1) + "%";
    }

    // FHIR Logic
    FHIR.oauth2.ready().then(client => {
        log("Connected to FHIR Server", client);
        document.getElementById('fhir-status').innerText = "Connected";
        document.getElementById('fhir-status').className = "text-success";

        // 1. Patient Info
        client.patient.read().then(pt => {
            const name = pt.name?.[0]?.family + (pt.name?.[0]?.given?.[0] || "");
            const pid = pt.id;
            const orgRef = pt.managingOrganization?.reference;
            
            // é¡¯ç¤ºç—…äººè³‡è¨Š
            document.getElementById('patient-info-display').innerHTML = 
                `<strong>${name}</strong> (ID: ${pid})<br><small>${orgRef || 'No Org'}</small>`;

            // æª¢æŸ¥æ˜¯å¦å±¬æ–¼ Organization/670423
            if (orgRef && orgRef.includes(TARGET_ORG_ID)) {
                log("æ©Ÿæ§‹é©—è­‰é€šé: ç—…äººå±¬æ–¼ 670423");
            } else {
                log("æ³¨æ„: æ­¤ç—…äººä¸å±¬æ–¼ Organization/670423", orgRef);
                alert(`æé†’ï¼šæ­¤ç—…äºº (ID:${pid}) ä¸¦æœªæ›åœ¨ Organization/${TARGET_ORG_ID} ä¸‹`);
            }

            // è¨ˆç®—å¹´é½¡
            if (pt.birthDate) {
                const today = new Date();
                const birthDate = new Date(pt.birthDate);
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
                
                const ageInput = document.getElementById('age');
                ageInput.value = age;
                ageInput.classList.add('auto-filled');
                calculateApacheII(); // è§¸ç™¼å³æ™‚è¨ˆç®—
            }
        });

        // 2. Fetch Observations
        // ç­–ç•¥ï¼šä¸€æ¬¡æŠ“å–è©²ç—…äººæ‰€æœ‰ vital-signs å’Œ laboratory è³‡æ–™ (ä¾æ—¥æœŸæ’åºï¼ŒæŠ“æœ€æ–°çš„)
        const q = new URLSearchParams();
        q.set("patient", client.patient.id);
        q.set("category", "vital-signs,laboratory");
        q.set("_sort", "-date");
        q.set("_count", "100"); // æŠ“å¤šä¸€é»ä»¥é˜²æ¼

        client.request(`Observation?${q}`).then(bundle => {
            if (!bundle.entry) {
                log("No Observations found");
                return;
            }

            log(`Found ${bundle.entry.length} observations`);
            
            // å»ºç«‹ä¸€å€‹ mapping è¿½è¹¤å“ªäº›å·²ç¶“å¡«é (å› ç‚ºåªè¦æœ€æ–°çš„)
            const filled = new Set();
            const inputs = document.querySelectorAll('.fhir-bind');

            bundle.entry.forEach(entry => {
                const obs = entry.resource;
                const code = obs.code?.coding?.find(c => c.system === "http://loinc.org")?.code;
                const value = obs.valueQuantity?.value;

                if (code && value !== undefined) {
                    // å°‹æ‰¾å°æ‡‰çš„ input
                    inputs.forEach(input => {
                        const targetCodes = input.dataset.loinc.split(',');
                        if (targetCodes.includes(code) && !filled.has(input.id)) {
                            input.value = value;
                            input.classList.add('auto-filled'); // åŠ ä¸Šè—è‰²å¤–æ¡†
                            filled.add(input.id);
                            log(`Matched ${code} -> #${input.id} = ${value}`);
                        }
                    });
                }
            });
            
            // è³‡æ–™å¡«å®Œå¾Œè‡ªå‹•ç®—ä¸€æ¬¡
            calculateApacheII();
        });

    }).catch(err => {
        log("FHIR Error", err);
        document.getElementById('fhir-status').innerText = "Error";
        document.getElementById('fhir-status').className = "text-danger";
    });
    
    // ç¶å®šæ‰€æœ‰ input è®Šå‹•æ™‚è‡ªå‹•é‡ç®—
    document.querySelectorAll('input').forEach(input => {
        input.addEventListener('change', calculateApacheII);
    });

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>