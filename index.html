<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APACHE II System - Org: 669597</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <style>
        body { background-color: #f4f6f9; font-family: "Microsoft JhengHei", sans-serif; }
        .header-bar { background-color: #2c3e50; color: white; padding: 10px 0; border-bottom: 5px solid #3498db; }
        .patient-card { cursor: pointer; transition: transform 0.2s; border-left: 5px solid transparent; }
        .patient-card:hover { transform: translateY(-3px); border-left: 5px solid #3498db; box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important; }
        .auto-filled { border: 2px solid #3498db !important; background-color: #ebf5fb !important; }
        .view-section { display: none; } /* é è¨­éš±è—æ‰€æœ‰å€å¡Šï¼Œç”± JS æ§åˆ¶é¡¯ç¤º */
        .active-view { display: block; }
    </style>
</head>
<body>

<nav class="header-bar sticky-top">
    <div class="container d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <h4 class="m-0 me-3">ğŸ¥ APACHE II</h4>
            <span class="badge bg-info text-dark">Org: 669597</span>
        </div>
        <div>
            <span id="current-patient-name" class="me-2 text-light small">æœªé¸æ“‡ç—…äºº</span>
            <button id="btn-switch-patient" class="btn btn-sm btn-outline-light" onclick="showPatientList()">åˆ‡æ›ç—…äºº</button>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div id="status-alert" class="alert alert-info py-2" style="display:none;"></div>

    <div id="view-patient-list" class="view-section active-view">
        <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="m-0 text-primary">ğŸ“‚ é¸æ“‡ç—…äºº (ç”± Org:669597 ç¯©é¸)</h5>
                <button class="btn btn-sm btn-primary" onclick="loadPatientList()">ğŸ”„ é‡æ–°æ•´ç†æ¸…å–®</button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>å§“å</th>
                                <th>æ€§åˆ¥</th>
                                <th>å‡ºç”Ÿæ—¥æœŸ (å¹´é½¡)</th>
                                <th>ID</th>
                                <th>å‹•ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="patient-table-body">
                            <tr><td colspan="5" class="text-center text-muted">æ­£åœ¨è®€å–ç—…äººæ¸…å–®...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="view-calculator" class="view-section">
        <div class="row">
            <div class="col-lg-8">
                <form id="apacheForm">
                    <div class="card mb-3 shadow-sm">
                        <div class="card-header text-primary fw-bold">A. åŸºæœ¬è³‡è¨Š (Age & Chronic)</div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">å¹´é½¡</label>
                                    <input type="number" class="form-control" id="age" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">æ…¢æ€§ç—…å²</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="chronic">
                                        <label class="form-check-label">åš´é‡å™¨å®˜è¡°ç«­ / å…ç–«ä¸å…¨</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="emergency-surgery">
                                        <label class="form-check-label">ç·Šæ€¥æ‰‹è¡“ (Emergency Surgery)</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3 shadow-sm">
                        <div class="card-header text-success fw-bold">B. ç”Ÿå‘½å¾µè±¡ (Vital Signs)</div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">é«”æº« (Â°C)</label>
                                    <input type="number" step="0.1" class="form-control fhir-bind" id="temp" data-loinc="8310-5,8331-1">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">MAP (mmHg)</label>
                                    <input type="number" class="form-control fhir-bind" id="map" data-loinc="8478-0">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">å¿ƒè·³ (bpm)</label>
                                    <input type="number" class="form-control fhir-bind" id="hr" data-loinc="8867-4">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">å‘¼å¸ (/min)</label>
                                    <input type="number" class="form-control fhir-bind" id="rr" data-loinc="9279-1">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3 shadow-sm">
                        <div class="card-header text-warning fw-bold">C. æ°§åˆ (Oxygenation)</div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">PaO2 (mmHg)</label>
                                    <input type="number" class="form-control fhir-bind" id="pao2" data-loinc="2703-7">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">A-aDO2</label>
                                    <input type="number" class="form-control" id="aado2">
                                </div>
                                <div class="col-12 form-check">
                                    <input class="form-check-input" type="checkbox" id="fio2-high">
                                    <label class="form-check-label">FiO2 >= 50% (æ”¹ç”¨ A-aDO2 è¨ˆåˆ†)</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3 shadow-sm">
                        <div class="card-header text-info fw-bold">D. è¡€æ¶²åŒ–å­¸</div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">pH</label>
                                    <input type="number" step="0.01" class="form-control fhir-bind" id="ph" data-loinc="2744-1">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Na</label>
                                    <input type="number" step="0.1" class="form-control fhir-bind" id="na" data-loinc="2951-2">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">K</label>
                                    <input type="number" step="0.1" class="form-control fhir-bind" id="k" data-loinc="2823-3">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Creatinine (Cr)</label>
                                    <input type="number" step="0.1" class="form-control fhir-bind" id="cr" data-loinc="2160-0">
                                    <div class="form-check mt-1 small">
                                        <input class="form-check-input" type="checkbox" id="arf">
                                        <label class="form-check-label">æ€¥æ€§è…è¡°ç«­ (ARF)</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Hct (%)</label>
                                    <input type="number" step="0.1" class="form-control fhir-bind" id="hct" data-loinc="20570-8,4544-3">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">WBC (x1000)</label>
                                    <input type="number" step="0.1" class="form-control fhir-bind" id="wbc" data-loinc="6690-2,26464-8">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3 shadow-sm">
                        <div class="card-header text-danger fw-bold">E. GCS (Glasgow Coma Scale)</div>
                        <div class="card-body">
                            <label class="form-label">GCS ç¸½åˆ† (3-15)</label>
                            <input type="number" class="form-control fhir-bind" id="gcs" max="15" min="3" value="15" data-loinc="9269-2">
                            <small class="text-muted">åˆ†æ•¸ = 15 - GCS</small>
                        </div>
                    </div>
                </form>
            </div>

            <div class="col-lg-4">
                <div class="card shadow border-0" style="position:sticky; top:80px;">
                    <div class="card-header bg-dark text-white text-center">
                        <h5 class="m-0">ç¸½åˆ†çµæœ</h5>
                    </div>
                    <div class="card-body text-center">
                        <h1 id="finalScore" class="display-3 fw-bold text-danger">0</h1>
                        <p class="text-muted">APACHE II Score</p>
                        <hr>
                        <h4 id="mortalityRate" class="text-secondary">-- %</h4>
                        <small>é ä¼°æ­»äº¡ç‡</small>
                        <button class="btn btn-primary w-100 mt-3" onclick="calculateApacheII()">é‡ç®—åˆ†æ•¸</button>
                    </div>
                    <div class="card-footer bg-light">
                         <small class="text-muted">å„é …å¾—åˆ†ç´°ç¯€:</small>
                         <div class="d-flex justify-content-between small"><span>Age:</span><b id="scoreAge">0</b></div>
                         <div class="d-flex justify-content-between small"><span>Chronic:</span><b id="scoreChronic">0</b></div>
                         <div class="d-flex justify-content-between small"><span>Physiology:</span><b id="scorePhys">0</b></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const TARGET_ORG_ID = "669597";
    let fhirClient = null;
    let currentPatientId = null;

    // --- é é¢æ§åˆ¶ ---
    function showPatientList() {
        document.getElementById('view-patient-list').style.display = 'block';
        document.getElementById('view-calculator').style.display = 'none';
        document.getElementById('btn-switch-patient').style.display = 'none'; // åœ¨æ¸…å–®é éš±è—åˆ‡æ›æŒ‰éˆ•
        
        // é‡ç½®è¡¨å–®
        document.getElementById('apacheForm').reset();
        document.getElementById('current-patient-name').innerText = "æœªé¸æ“‡ç—…äºº";
        
        // æ¸…é™¤æ‰€æœ‰è—è‰²æ¡†æ¡†
        document.querySelectorAll('.auto-filled').forEach(el => el.classList.remove('auto-filled'));
        calculateApacheII();
    }

    function showCalculator(patient) {
        document.getElementById('view-patient-list').style.display = 'none';
        document.getElementById('view-calculator').style.display = 'block';
        document.getElementById('btn-switch-patient').style.display = 'inline-block';

        // è¨­å®šç›®å‰ç—…äººè³‡è¨Š
        //const name = patient.name?.[0]?.family + (patient.name?.[0]?.given?.[0] || "");
        let name = "";
        if (pt.name && pt.name.length > 0) {
            // 1. å„ªå…ˆä½¿ç”¨å®Œæ•´é¡¯ç¤ºæ–‡å­— (text)
            if (pt.name[0].text) {
                name = pt.name[0].text;
            } 
            // 2. å¦‚æœæ²’æœ‰ textï¼Œæ‰å˜—è©¦çµ„è£ family + given
            else {
                const family = pt.name[0].family || "";
                const given = pt.name[0].given ? pt.name[0].given.join("") : "";
                name = family + given;
            }
        }
        document.getElementById('current-patient-name').innerText = `ç›®å‰ç—…äºº: ${name}`;
        
        // é–‹å§‹è¼‰å…¥è³‡æ–™
        currentPatientId = patient.id;
        loadPatientData(patient);
    }

    // --- FHIR é‚è¼¯ ---
    FHIR.oauth2.ready().then(client => {
        fhirClient = client;
        console.log("FHIR Client Ready", client);
        
        // 1. å…ˆè®€å–æ©Ÿæ§‹ä¸‹çš„ç—…äººæ¸…å–®
        loadPatientList();

    }).catch(console.error);

    function loadPatientList() {
        if (!fhirClient) return;
        const tbody = document.getElementById('patient-table-body');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-primary">æ­£åœ¨å¾ FHIR Server è®€å– Org:670423 çš„ç—…äºº...</td></tr>';

        // æŸ¥è©¢æ¢ä»¶ï¼šOrganization = 670423
        fhirClient.request(`Patient?organization=${TARGET_ORG_ID}&_sort=-_lastUpdated`).then(bundle => {
            tbody.innerHTML = '';
            
            if (!bundle.entry || bundle.entry.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">æ‰¾ä¸åˆ°ç—…äºº (Org:670423) <br> è«‹ç¢ºèªæ˜¯å¦å·²åŸ·è¡Œã€Œå‡è³‡æ–™åŒ¯å…¥ã€æ­¥é©Ÿ</td></tr>';
                return;
            }

            bundle.entry.forEach(entry => {
                const pt = entry.resource;
                const name = pt.name?.[0]?.family + (pt.name?.[0]?.given?.[0] || "");
                const gender = pt.gender || "--";
                const birth = pt.birthDate || "--";
                const age = pt.birthDate ? getAge(pt.birthDate) + " æ­²" : "--";
                const pid = pt.id;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="fw-bold text-primary">${name}</td>
                    <td>${gender}</td>
                    <td>${birth} <small class="text-muted">(${age})</small></td>
                    <td><small class="font-monospace">${pid}</small></td>
                    <td><button class="btn btn-sm btn-outline-primary">é¸æ“‡</button></td>
                `;
                tr.onclick = () => showCalculator(pt);
                tr.style.cursor = "pointer";
                tbody.appendChild(tr);
            });
        }).catch(err => {
            console.error(err);
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">è®€å–å¤±æ•—: ${err}</td></tr>`;
        });
    }

    // --- è¨ˆç®—æ©Ÿé‚è¼¯ (è¼‰å…¥ç—…äººè³‡æ–™) ---
    function loadPatientData(pt) {
        // 1. å¡«å…¥å¹´é½¡
        if (pt.birthDate) {
            const age = getAge(pt.birthDate);
            document.getElementById('age').value = age;
            document.getElementById('age').classList.add('auto-filled');
        }

        // 2. æŠ“å– Observations
        const q = new URLSearchParams();
        q.set("patient", pt.id);
        q.set("category", "vital-signs,laboratory");
        q.set("_sort", "-date");
        q.set("_count", "100");

        fhirClient.request(`Observation?${q}`).then(bundle => {
            if (bundle.entry) {
                const filled = new Set();
                const inputs = document.querySelectorAll('.fhir-bind');

                bundle.entry.forEach(entry => {
                    const obs = entry.resource;
                    const code = obs.code?.coding?.find(c => c.system === "http://loinc.org")?.code;
                    const value = obs.valueQuantity?.value;

                    if (code && value !== undefined) {
                        inputs.forEach(input => {
                            const targetCodes = input.dataset.loinc.split(',');
                            if (targetCodes.includes(code) && !filled.has(input.id)) {
                                input.value = value;
                                input.classList.add('auto-filled');
                                filled.add(input.id);
                            }
                        });
                    }
                });
            }
            // è¼‰å…¥å®Œç•¢å¾Œè¨ˆç®—ä¸€æ¬¡
            calculateApacheII();
        });
    }

    // --- å·¥å…·å‡½å¼ ---
    function getAge(dateString) {
        const today = new Date();
        const birthDate = new Date(dateString);
        let age = today.getFullYear() - birthDate.getFullYear();
        const m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
        return age;
    }

    // --- è¨ˆç®—æ ¸å¿ƒ (Knaus et al.) ---
    function getScore(val, ranges) {
        if (val === "" || val === undefined || isNaN(val)) return 0;
        val = parseFloat(val);
        for (let r of ranges) {
            let min = r.min !== undefined ? r.min : -Infinity;
            let max = r.max !== undefined ? r.max : Infinity;
            if (val >= min && val <= max) return r.score;
        }
        return 0;
    }

    function calculateApacheII() {
        let physScore = 0;
        
        // 1. Age
        const age = parseFloat(document.getElementById('age').value) || 0;
        let ageScore = 0;
        if (age >= 75) ageScore = 6;
        else if (age >= 65) ageScore = 5;
        else if (age >= 55) ageScore = 3;
        else if (age >= 45) ageScore = 2;
        document.getElementById('scoreAge').innerText = ageScore;

        // 2. Chronic
        let chronicScore = 0;
        if (document.getElementById('chronic').checked) {
            chronicScore = document.getElementById('emergency-surgery').checked ? 5 : 2; 
        }
        document.getElementById('scoreChronic').innerText = chronicScore;

        // 3. Physiology (éƒ¨åˆ†ç¯„ä¾‹ï¼Œå®Œæ•´é‚è¼¯åŒå‰ä¸€ç‰ˆ)
        // Temp
        physScore += getScore(document.getElementById('temp').value, [
            {min: 41, score: 4}, {min: 39, max: 40.9, score: 3}, {min: 38.5, max: 38.9, score: 1},
            {min: 36, max: 38.4, score: 0}, {min: 34, max: 35.9, score: 1}, {min: 32, max: 33.9, score: 2},
            {min: 30, max: 31.9, score: 3}, {max: 29.9, score: 4}
        ]);
        // MAP
        physScore += getScore(document.getElementById('map').value, [
            {min: 160, score: 4}, {min: 130, max: 159, score: 3}, {min: 110, max: 129, score: 2},
            {min: 70, max: 109, score: 0}, {min: 50, max: 69, score: 2}, {max: 49, score: 4}
        ]);
        // HR
        physScore += getScore(document.getElementById('hr').value, [
            {min: 180, score: 4}, {min: 140, max: 179, score: 3}, {min: 110, max: 139, score: 2},
            {min: 70, max: 109, score: 0}, {min: 55, max: 69, score: 2}, {min: 40, max: 54, score: 3}, {max: 39, score: 4}
        ]);
        // RR
        physScore += getScore(document.getElementById('rr').value, [
            {min: 50, score: 4}, {min: 35, max: 49, score: 3}, {min: 25, max: 34, score: 1},
            {min: 12, max: 24, score: 0}, {min: 10, max: 11, score: 1}, {min: 6, max: 9, score: 2}, {max: 5, score: 4}
        ]);
        // GCS
        const gcs = parseFloat(document.getElementById('gcs').value) || 15;
        physScore += (15 - gcs);
        
        // ... (å…¶é¤˜å¦‚ Na, K, WBC, Hct, Cr, pH è«‹ä¾ç…§å‰ä¸€ç‰ˆå®Œæ•´è£œä¸Šï¼Œç‚ºç¯€çœé•·åº¦æ­¤è™•çœç•¥é‡è¤‡ä»£ç¢¼ï¼Œä½†å¯¦éš›é‹ä½œè«‹å‹™å¿…ä¿ç•™) ...
        // ç‚º Demo æ•ˆæœï¼Œè£œä¸Š WBC çš„è¨ˆç®—
        physScore += getScore(document.getElementById('wbc').value, [
            {min: 40, score: 4}, {min: 20, max: 39.9, score: 2}, {min: 15, max: 19.9, score: 1},
            {min: 3, max: 14.9, score: 0}, {min: 1, max: 2.9, score: 2}, {max: 0.9, score: 4}
        ]);

        document.getElementById('scorePhys').innerText = physScore;

        // Total
        const total = ageScore + chronicScore + physScore;
        document.getElementById('finalScore').innerText = total;

        // Mortality (Simplified)
        const logit = -3.517 + (total * 0.146) + (document.getElementById('emergency-surgery').checked ? 0.603 : 0);
        const risk = Math.exp(logit) / (1 + Math.exp(logit));
        document.getElementById('mortalityRate').innerText = (risk * 100).toFixed(1) + "%";
    }

    // ç¶å®šè¼¸å…¥äº‹ä»¶
    document.querySelectorAll('input').forEach(input => {
        input.addEventListener('input', calculateApacheII);
        input.addEventListener('change', calculateApacheII);
    });

</script>
</body>
</html>